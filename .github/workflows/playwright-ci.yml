# =============================================================================
# GitHub Actions Workflow for Playwright Python Tests
# =============================================================================
# This workflow automates running Playwright tests on every push and PR.
# It sets up Python, installs dependencies, runs tests, and uploads results.
# =============================================================================

name: Playwright Python Tests

# =============================================================================
# TRIGGERS: When this workflow runs
# =============================================================================
on:
  # Run on every push to any branch
  push:
    branches:
      - '**'  # All branches
  
  # Run on every pull request targeting any branch
  pull_request:
    branches:
      - '**'  # All branches
  
  # Allow manual triggering from GitHub UI (optional but useful)
  workflow_dispatch:

# =============================================================================
# JOBS: Define what work to perform
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # TEST JOB: Main job that runs Playwright tests
  # ---------------------------------------------------------------------------
  playwright-tests:
    
    # -------------------------------------------------------------------------
    # RUNNER: Ubuntu is recommended for Playwright (better stability)
    # -------------------------------------------------------------------------
    runs-on: ubuntu-latest
    
    # -------------------------------------------------------------------------
    # TIMEOUT: Prevent jobs from running indefinitely (default is 360 min)
    # -------------------------------------------------------------------------
    timeout-minutes: 30
    
    # -------------------------------------------------------------------------
    # STRATEGY: Run tests with multiple Python versions (optional)
    # -------------------------------------------------------------------------
    strategy:
      fail-fast: false  # Continue other versions even if one fails
      matrix:
        python-version: ['3.11']  # Add more versions if needed: ['3.10', '3.11', '3.12']
    
    # -------------------------------------------------------------------------
    # STEPS: Sequential actions to execute
    # -------------------------------------------------------------------------
    steps:
      
      # -----------------------------------------------------------------------
      # STEP 1: Checkout code
      # Downloads your repository code to the runner
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # -----------------------------------------------------------------------
      # STEP 2: Setup Python environment
      # Installs specified Python version and configures pip caching
      # -----------------------------------------------------------------------
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'  # Cache pip dependencies for faster builds
      
      # -----------------------------------------------------------------------
      # STEP 3: Install Python dependencies
      # Installs packages from requirements.txt
      # -----------------------------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # -----------------------------------------------------------------------
      # STEP 4: Install Playwright browsers
      # Downloads Chromium, Firefox, and WebKit browsers
      # -----------------------------------------------------------------------
      - name: Install Playwright browsers
        run: |
          playwright install chromium firefox webkit
      
      # -----------------------------------------------------------------------
      # STEP 5: Install system dependencies for browsers
      # CRITICAL for Linux: Installs OS libraries needed by browsers
      # Without this, tests will fail on CI with "browser not found" errors
      # -----------------------------------------------------------------------
      - name: Install Playwright system dependencies
        run: |
          playwright install-deps
      
      # -----------------------------------------------------------------------
      # STEP 6: Run Playwright tests
      # Executes pytest with Playwright tests
      # Options:
      #   --headed: Run browsers visibly (remove for headless)
      #   --browser: Specify which browser(s) to test
      #   --maxfail=1: Stop after first failure (faster feedback)
      #   --disable-warnings: Cleaner output
      #   -v: Verbose output (use -q for quiet)
      #   --tracing=retain-on-failure: Keep traces only for failed tests
      # -----------------------------------------------------------------------
      - name: Run Playwright tests
        run: |
          pytest \
            --browser=chromium \
            --headed \
            --tracing=retain-on-failure \
            --video=retain-on-failure \
            --screenshot=only-on-failure \
            --maxfail=1 \
            --disable-warnings \
            -v
        continue-on-error: false  # Fail the job if tests fail
      
      # -----------------------------------------------------------------------
      # STEP 7: Upload test artifacts
      # Saves screenshots, videos, traces, and HTML report for debugging
      # 'if: always()' ensures this runs even when tests fail
      # -----------------------------------------------------------------------
      - name: Upload Playwright artifacts
        uses: actions/upload-artifact@v4
        if: always()  # Run even if previous steps failed
        with:
          name: playwright-results-${{ matrix.python-version }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7  # Keep artifacts for 7 days
      
      # -----------------------------------------------------------------------
      # STEP 8: Upload HTML report (optional)
      # Creates a viewable HTML report of test results
      # -----------------------------------------------------------------------
      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-html-report-${{ matrix.python-version }}
          path: playwright-report/
          retention-days: 7
      
      # -----------------------------------------------------------------------
      # STEP 9: Publish test results summary (optional)
      # Shows test results directly in GitHub PR/commit checks
      # -----------------------------------------------------------------------
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            test-results/**/*.xml
          check_name: Playwright Test Results

# =============================================================================
# DEBUGGING TIPS FOR CI FAILURES:
# =============================================================================
# 1. Check the "Actions" tab in GitHub to see workflow runs
# 2. Click on a failed run to see which step failed
# 3. Download artifacts (screenshots, videos, traces) from the bottom of run page
# 4. Open traces in https://trace.playwright.dev for detailed debugging
# 5. Re-run failed jobs with debug logging: Add PWDEBUG=1 to environment
# =============================================================================